<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChÃ¡ de casa nova - Bya e Ranny</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-dancing {
            font-family: 'Dancing Script', cursive;
        }
        /* Estilo para animaÃ§Ã£o de fade-in do modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-stone-100 text-gray-800">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- CabeÃ§alho -->
        <header class="text-center mb-8 md:mb-12">
            <h1 class="font-dancing text-5xl md:text-7xl text-stone-800">Nosso ChÃ¡ de Casa Nova</h1>
            <p class="text-gray-500 mt-2 text-lg">Bya & Ranny</p>
        </header>

        <!-- SeÃ§Ã£o de IdentificaÃ§Ã£o do Convidado (Inicialmente visÃ­vel) -->
        <section id="guest-login" class="bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-700">Seja bem-vindo(a)!</h2>
            
            <!-- Mensagem dos noivos -->
            <div class="bg-stone-50/60 p-4 rounded-lg text-gray-700 text-sm text-left mb-6 border border-stone-100">
                <p class="mb-3">A casa Ã© nova, a vida Ã© nova e a gente quer celebrar essa nova fase incrÃ­vel da nossa vida com as pessoas mais especiais: VOCÃŠS! Para nos ajudar a montar o apÃª dos sonhos (e evitar presentes repetidos!), criamos essa listinha especial.</p>
                <p class="mb-2 font-semibold">As cores da decoraÃ§Ã£o do nosso apÃª sÃ£o:</p>
                <ul class="list-disc list-inside mb-4 text-gray-600">
                    <li>Preto, cinza, branco e madeira.</li>
                </ul>
                <p>Qualquer dÃºvida, os noivos estÃ£o Ã  disposiÃ§Ã£o! ğŸ‘</p>
            </div>

            <p class="text-center mb-6 text-gray-600">Para continuar e ver a lista, digite seu nome:</p>
            <div class="space-y-4">
                <input type="text" id="guest-name" placeholder="Seu nome e sobrenome" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-500 transition">
                <button id="start-button" class="w-full bg-stone-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-stone-800 transition-all duration-300 transform hover:scale-105">Ver Lista de Presentes</button>
            </div>
            <p id="name-error" class="text-red-500 text-sm mt-2 text-center hidden">Por favor, preencha seu nome.</p>
        </section>

        <!-- SeÃ§Ã£o da Lista de Presentes (Inicialmente oculta) -->
        <section id="gift-section" class="hidden">
             <div class="text-center mb-8">
                <p class="text-xl">OlÃ¡, <strong id="welcome-guest-name" class="text-stone-900"></strong>!</p>
                <p class="text-gray-600">Escolha um item abaixo com carinho. Agradecemos sua contribuiÃ§Ã£o!</p>
            </div>
            <div id="gift-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards de presentes serÃ£o inseridos aqui pelo JavaScript -->
                 <div class="text-center p-8 col-span-full">
                    <p class="text-gray-500">Carregando lista de presentes...</p>
                </div>
            </div>
        </section>

        <!-- SeÃ§Ã£o de Agradecimento (Inicialmente oculta) -->
        <section id="thank-you-section" class="hidden text-center bg-white p-8 md:p-12 rounded-xl shadow-md max-w-lg mx-auto">
            <h2 class="text-3xl font-bold text-green-600 mb-4">âœ… Suas escolhas foram salvas âœ…</h2>
            <p class="text-gray-700 text-lg mb-6">Obrigado por fazer parte disso!</p>
            <div class="bg-stone-50/60 p-6 rounded-lg text-gray-700 space-y-4 border border-stone-100">
                <p>Uhuuuu!ğŸ‰ğŸ‰ Seu presente vai fazer a nossa casa ainda mais bonita! VocÃª arrasou na escolha.</p>
                <p>Seu carinho e seu presente significam muito pra gente. Muito obrigado por nos ajudar a montar nosso lar e por fazer parte desse momento especial para nÃ³s!ğŸ’•</p>
                <p class="font-bold text-stone-900">Esperamos vocÃª dia 01/11 para comemorar com a gente!!!</p>
            </div>
        </section>

    </div>
    
    <!-- BotÃ£o Flutuante para Finalizar -->
    <button id="finish-button" class="hidden fixed bottom-6 right-6 bg-stone-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 z-40 opacity-50 cursor-not-allowed" disabled>
        Finalizar escolhas
    </button>

    <!-- Modal de ConfirmaÃ§Ã£o -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-8 shadow-2xl max-w-sm w-full text-center transform transition-all scale-95">
            <h3 class="text-xl font-bold mb-4">Confirmar Escolha?</h3>
            <p class="mb-6">VocÃª estÃ¡ prestes a escolher <strong id="modal-item-name" class="text-stone-900"></strong>. Este item serÃ¡ marcado em seu nome.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirm-button" class="px-6 py-2 bg-stone-700 text-white font-bold rounded-lg hover:bg-stone-800 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de InstruÃ§Ãµes -->
    <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-8 shadow-2xl max-w-lg w-full text-left transform transition-all scale-95 animate-fade-in">
            <h3 class="text-2xl font-bold mb-4 text-center text-stone-800">Como o site funciona? ğŸ§</h3>
            <p class="mb-5 text-gray-600">Nesta lista deixamos todos os itens que agregarÃ£o no nosso cantinho. Siga esses passos para dar tudo certo com a sua escolha:</p>
            <ol class="list-decimal list-inside space-y-3 text-gray-700">
                <li>Escolha os itens desejados, Ã© possÃ­vel escolher mais de um item (fique Ã  vontade kkk ğŸ˜‚).</li>
                <li>Clique em 'Ver produto' ğŸ›ï¸, vocÃª serÃ¡ direcionado para o site do item para realizar a compra.</li>
                <li>ApÃ³s finalizar a compra, retorne nesse site e clique em 'Escolher presente' para registrar sua escolha (pra ninguÃ©m comprar o presente igual o seu kkk ğŸ˜‰).</li>
                <li>Clique em 'Finalizar escolhas' âœ… para encerrar e salvar suas escolhas.</li>
            </ol>
            <div class="flex justify-center mt-8">
                <button id="close-instructions-button" class="px-8 py-3 bg-stone-700 text-white font-bold rounded-lg hover:bg-stone-800 transition-transform transform hover:scale-105">Entendi!</button>
            </div>
        </div>
    </div>


    <!-- Script do Firebase e LÃ³gica da AplicaÃ§Ã£o -->
    <script type="module">
        // ImportaÃ§Ãµes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ************************************************************************************
        // COLE A CONFIGURAÃ‡ÃƒO DO SEU FIREBASE AQUI
        // ************************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyAvI2t9dXajuZClHUImty038scK4xwfiZs",
            authDomain: "cha-de-cozinha-626ad.firebaseapp.com",
            projectId: "cha-de-cozinha-626ad",
            storageBucket: "cha-de-cozinha-626ad.appspot.com",
            messagingSenderId: "424924149259",
            appId: "1:424924149259:web:c1cef51b6bc0dd5653790e"
        };
        // ************************************************************************************

        // ####################################################################################
        // ##                                                                                ##
        // ##  --> SUA LISTA DE PRESENTES <--                                                ##
        // ##  Ajuste os nomes, links, Ã­cones e quantidades como desejar.                    ##
        // ##                                                                                ##
        // ####################################################################################
        const initialGiftList = [
            { name: 'Abridor de latas', icon: 'ğŸ¥«', link: 'https://s.shopee.com.br/9UpsV32XgH', quantity: 1 },
            { name: 'Abridor de potes', icon: 'ğŸ«™', link: 'https://s.shopee.com.br/AA7ftpl0V0', quantity: 1 },
            { name: 'Airfrier', icon: 'ğŸŸ', link: 'https://s.shopee.com.br/2B5ODNMGY9', quantity: 1 },
            { name: 'Almofada', icon: 'ğŸ›‹ï¸', link: 'https://s.shopee.com.br/6KuxMEPFFC', quantity: 1 },
            { name: 'Amassador de batata', icon: 'ğŸ¥”', link: 'https://s.shopee.com.br/9zoFgmztN9', quantity: 1 },
            { name: 'Aparelho de jantar (18 peÃ§as)', icon: 'ğŸ½ï¸', link: 'https://s.shopee.com.br/6KuxBLKnPx', quantity: 2 },
            { name: 'Balde', icon: 'ğŸª£', link: 'https://s.shopee.com.br/4L9t5PbEqp', quantity: 2 },
            { name: 'Batedeira', icon: 'ğŸ°', link: 'https://s.shopee.com.br/9pUpLu8ZUB', quantity: 1 },
            { name: 'Boleira', icon: 'ğŸ‚', link: 'https://s.shopee.com.br/3qDcLvbz1B', quantity: 1 },
            { name: 'Cafeteira', icon: 'â˜•', link: 'https://s.shopee.com.br/3ValoQbRRO', quantity: 1 },
            { name: 'Caneca/Leiteira', icon: 'ğŸ¥›', link: 'https://s.shopee.com.br/5L2Q7UIEj2', quantity: 1 },
            { name: 'Capa para almofadas', icon: 'ğŸ›‹ï¸', link: 'https://s.shopee.com.br/8UzRz9R8q3', quantity: 4 },
            { name: 'Chaleira elÃ©trica', icon: 'ğŸ’§', link: 'https://s.shopee.com.br/3ValvmBdCr', quantity: 1 },
            { name: 'Coberdrom', icon: 'ğŸ›Œ', link: 'https://s.shopee.com.br/6fXnkMnIGs', quantity: 2 },
            { name: 'Copo de medida', icon: 'ğŸ§ª', link: 'https://s.shopee.com.br/8fIrzbJpP4', quantity: 1 },
            { name: 'Edredom', icon: 'ğŸ›Œ', link: 'https://s.shopee.com.br/4fmjMlJl6I', quantity: 2 },
            { name: 'Escorredor de louÃ§as', icon: 'ğŸ½ï¸', link: 'https://s.shopee.com.br/5L2Q6UcoSm', quantity: 1 },
            { name: 'Escorredor de macarrÃ£o', icon: 'ğŸ', link: 'https://s.shopee.com.br/8UzRnrNvIG', quantity: 1 },
            { name: 'Espremedor de laranja', icon: 'ğŸŠ', link: 'https://s.shopee.com.br/6KuxE8q6fy', quantity: 1 },
            { name: 'Ferro de passar', icon: 'ğŸ‘”', link: 'https://br.shp.ee/VC2uapk', quantity: 1 },
            { name: 'Garrafa de cafÃ©', icon: 'â˜•', link: 'https://s.shopee.com.br/AKR60Tgy3l', quantity: 1 },
            { name: 'Jarra de suco', icon: 'ğŸ¹', link: 'https://s.shopee.com.br/5AizrPyWsY', quantity: 1 },
            { name: 'Jogo americano (opÃ§Ã£o 1)', icon: 'ğŸ½ï¸', link: 'https://s.shopee.com.br/2g1enQFqWo', quantity: 1 },
            { name: 'Jogo americano (opÃ§Ã£o 2)', icon: 'ğŸ½ï¸', link: 'https://s.shopee.com.br/3AxvibCU1V', quantity: 1 },
            { name: 'Jogo de cama', icon: 'ğŸ›ï¸', link: 'https://s.shopee.com.br/2g1eyITZDu', quantity: 3 },
            { name: 'Jogo de copos (12 un)', icon: 'ğŸ¥ƒ', link: 'https://s.shopee.com.br/9pUpNty4yI', quantity: 2 },
            { name: 'Jogo de peneira', icon: 'ğŸ§‘â€ğŸ³', link: 'https://s.shopee.com.br/4fmjKSXWfa', quantity: 1 },
            { name: 'Jogo de taÃ§as', icon: 'ğŸ·', link: 'https://s.shopee.com.br/3LHLeAQN9f', quantity: 2 },
            { name: 'Jogo de talher', icon: 'ğŸ´', link: 'https://s.shopee.com.br/30eVF11RVi', quantity: 2 },
            { name: 'Kit Bar', icon: 'ğŸ¸', link: 'https://s.shopee.com.br/2ViEuztVwe', quantity: 1 },
            { name: 'Kit Banheiro', icon: 'ğŸ›', link: 'https://s.shopee.com.br/8UzS2RWjMK', quantity: 1 },
            { name: 'Kit Churrasco', icon: 'ğŸ–', link: 'https://s.shopee.com.br/803BSwpoa2', quantity: 1 },
            { name: 'Kit Cozinha', icon: 'ğŸ³', link: 'https://s.shopee.com.br/40X2OTzkcr', quantity: 1 },
            { name: 'Kit Formas', icon: 'ğŸ§‘â€ğŸ³', link: 'https://s.shopee.com.br/9pUpPFqcBE', quantity: 1 },
            { name: 'Kit lavanderia/dispenser', icon: 'ğŸ§¼', link: 'https://s.shopee.com.br/6VENfeDjBM', quantity: 1 },
            { name: 'Kit Marinex', icon: 'ğŸ²', link: 'https://s.shopee.com.br/50PZgLlevr', quantity: 1 },
            { name: 'Liquidificador', icon: 'ğŸ¥¤', link: 'https://s.shopee.com.br/7pjl2X0nHK', quantity: 1 },
            { name: 'Manta', icon: 'ğŸ§£', link: 'https://s.shopee.com.br/803BL2L24E', quantity: 2 },
            { name: 'Manta para sofÃ¡', icon: 'ğŸ›‹ï¸', link: 'https://s.shopee.com.br/8zviX0Miyl', quantity: 1 },
            { name: 'Martelo de carne', icon: 'ğŸ”¨', link: 'https://s.shopee.com.br/7KnUVlDH8e', quantity: 1 },
            { name: 'Panela de pressÃ£o', icon: 'ğŸ³', link: 'https://s.shopee.com.br/2LOoVNX64A', quantity: 1 },
            { name: 'Panela de pressÃ£o elÃ©trica', icon: 'âš¡', link: 'https://s.shopee.com.br/4q69TkTEcG', quantity: 1 },
            { name: 'Pipoqueira', icon: 'ğŸ¿', link: 'https://s.shopee.com.br/8fIs5THyvs', quantity: 1 },
            { name: 'Porta Frios (4 un)', icon: 'ğŸ§€', link: 'https://s.shopee.com.br/6fXngSoK8P', quantity: 1 },
            { name: 'Pote hermÃ©tico', icon: 'ğŸ«™', link: 'https://s.shopee.com.br/40X2XXNzOV', quantity: 2 },
            { name: 'Processador/mixer', icon: 'ğŸŒªï¸', link: 'https://s.shopee.com.br/3fuC7tKFD3', quantity: 1 },
            { name: 'TaÃ§a de sobremesa', icon: 'ğŸ¨', link: 'https://s.shopee.com.br/5AizsrX2g8', quantity: 2 },
            { name: 'Tampa de microondas', icon: 'ğŸ²', link: 'https://s.shopee.com.br/9fBPIzy5dN', quantity: 1 },
            { name: 'Tapete de Banheiro', icon: 'ğŸšª', link: 'https://s.shopee.com.br/1g97u2fVQv', quantity: 2 },
            { name: 'Toalha de banho', icon: 'ğŸ›€', link: 'https://s.shopee.com.br/4fmjRtwQLT', quantity: 4 },
            { name: 'Toalha de mesa', icon: 'ğŸ½ï¸', link: 'https://s.shopee.com.br/2ViEaytJXK', quantity: 2 },
            { name: 'Toalha de rosto', icon: 'ğŸ§¼', link: 'https://s.shopee.com.br/803BQGDLU0', quantity: 4 },
            { name: 'Vaso de flor', icon: 'ğŸ’', link: 'https://s.shopee.com.br/803B9MwJ4Z', quantity: 1 },
        ];
        // ####################################################################################

        // InicializaÃ§Ã£o do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Elementos da pÃ¡gina
        const guestLoginSection = document.getElementById('guest-login');
        const giftSection = document.getElementById('gift-section');
        const guestNameInput = document.getElementById('guest-name');
        const startButton = document.getElementById('start-button');
        const nameError = document.getElementById('name-error');
        const giftListContainer = document.getElementById('gift-list');
        const welcomeGuestName = document.getElementById('welcome-guest-name');
        const thankYouSection = document.getElementById('thank-you-section');
        const finishButton = document.getElementById('finish-button');
        
        // Elementos do Modal
        const modal = document.getElementById('confirmation-modal');
        const modalItemName = document.getElementById('modal-item-name');
        const cancelButton = document.getElementById('cancel-button');
        const instructionsModal = document.getElementById('instructions-modal');
        const closeInstructionsButton = document.getElementById('close-instructions-button');
        
        let guestName = '';
        let localGiftsData = []; 
        let isListeningForGifts = false;

        // FunÃ§Ã£o para popular a lista de presentes no Firebase (apenas se estiver vazia)
        const initializeGiftListIfNeeded = async () => {
            const giftsCollection = collection(db, "gifts");
            try {
                const snapshot = await getDocs(giftsCollection);
                
                if (snapshot.empty) {
                    console.log("ColeÃ§Ã£o 'gifts' estÃ¡ vazia. Populando com a lista inicial...");
                    const promises = initialGiftList.map(gift => {
                        return addDoc(giftsCollection, {
                            name: gift.name,
                            quantity: gift.quantity || 1,
                            chosenCount: 0,
                            chosenBy: []
                        });
                    });
                    await Promise.all(promises);
                    console.log("Lista de presentes inicializada no Firebase!");
                } else {
                    console.log("ColeÃ§Ã£o 'gifts' jÃ¡ contÃ©m dados.");
                }
            } catch (error) {
                console.error("Erro ao inicializar a lista de presentes: ", error);
            }
        };

        // Autentica o usuÃ¡rio e inicializa a lista de presentes
        signInAnonymously(auth)
            .then(() => {
                console.log("Autenticado anonimamente com sucesso.");
                initializeGiftListIfNeeded();
            })
            .catch((error) => {
                console.error("Erro na autenticaÃ§Ã£o anÃ´nima:", error);
                giftListContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Erro de autenticaÃ§Ã£o. Por favor, recarregue a pÃ¡gina.</p>`;
            });


        // FunÃ§Ã£o para renderizar a lista de presentes
        const renderGifts = (giftsFromFirebase) => {
            giftListContainer.innerHTML = ''; 
            let currentUserHasChosen = false; 

            if (!giftsFromFirebase.length) {
                 giftListContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">A lista de presentes ainda nÃ£o foi cadastrada. Volte mais tarde!</p>`;
                 return;
            }
            
            localGiftsData = giftsFromFirebase.map(dbGift => {
                if (dbGift.chosenBy && dbGift.chosenBy.includes(guestName)) {
                    currentUserHasChosen = true;
                }
                const localGift = initialGiftList.find(lg => lg.name === dbGift.name);
                return { 
                    ...dbGift, 
                    link: localGift ? localGift.link : null,
                    icon: localGift ? localGift.icon : 'ğŸ'
                };
            });

            if (currentUserHasChosen) {
                finishButton.disabled = false;
                finishButton.classList.remove('opacity-50', 'cursor-not-allowed');
                finishButton.classList.add('hover:bg-stone-800', 'transform', 'hover:scale-110');
            } else {
                finishButton.disabled = true;
                finishButton.classList.add('opacity-50', 'cursor-not-allowed');
                finishButton.classList.remove('hover:bg-stone-800', 'transform', 'hover:scale-110');
            }

            localGiftsData.sort((a, b) => (a.chosenCount >= a.quantity) - (b.chosenCount >= b.quantity));

            localGiftsData.forEach(gift => {
                const isFullyChosen = gift.chosenCount >= gift.quantity;
                const availableCount = gift.quantity - gift.chosenCount;
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-md flex flex-col transition-all duration-300 overflow-hidden ${isFullyChosen ? 'opacity-50 grayscale' : 'hover:shadow-lg hover:transform hover:-translate-y-1'}`;

                card.innerHTML = `
                    <div class="p-5 flex flex-col items-center text-center flex-grow w-full">
                        <div class="text-6xl mb-4">${gift.icon || 'ğŸ'}</div>
                        <h3 class="font-bold text-lg text-gray-800 mb-2 flex-grow">${gift.name}</h3>
                        <p class="font-semibold text-sm my-4 ${isFullyChosen ? 'text-red-500' : 'text-green-600'}">
                            ${isFullyChosen ? 'IndisponÃ­vel' : `DisponÃ­vel (${availableCount} de ${gift.quantity})`}
                        </p>
                        
                        <div class="w-full mt-auto pt-4 border-t border-gray-100 space-y-2">
                            ${gift.link ? `<a href="${gift.link}" target="_blank" rel="noopener noreferrer" class="block w-full bg-white border border-stone-700 text-stone-700 font-bold py-2 px-4 rounded-lg hover:bg-stone-50 transition-colors duration-300">Ver produto</a>` : ''}
                            
                            <button 
                                data-id="${gift.id}" 
                                data-name="${gift.name}"
                                class="w-full text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 ${isFullyChosen ? 'bg-gray-400 cursor-not-allowed' : 'bg-stone-700 hover:bg-stone-800'}"
                                ${isFullyChosen ? 'disabled' : ''}
                            >
                                ${isFullyChosen ? 'IndisponÃ­vel' : 'Escolher Presente'}
                            </button>
                        </div>
                    </div>
                `;
                giftListContainer.appendChild(card);
            });

            document.querySelectorAll('button[data-id]').forEach(button => {
                if (!button.disabled) {
                    button.addEventListener('click', (e) => {
                        const giftId = e.currentTarget.getAttribute('data-id');
                        const giftName = e.currentTarget.getAttribute('data-name');
                        showConfirmationModal(giftId, giftName);
                    });
                }
            });
        };

        const showConfirmationModal = (giftId, giftName) => {
            modalItemName.textContent = giftName;
            modal.classList.remove('hidden');
            
            let currentConfirmButton = document.getElementById('confirm-button');
            const newConfirmButton = currentConfirmButton.cloneNode(true);
            currentConfirmButton.parentNode.replaceChild(newConfirmButton, currentConfirmButton);
            
            newConfirmButton.addEventListener('click', () => handleGiftSelection(giftId));
            document.body.style.overflow = 'hidden';
        };

        const hideConfirmationModal = () => {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        };
        
        cancelButton.addEventListener('click', hideConfirmationModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideConfirmationModal();
        });

        const handleGiftSelection = async (giftId) => {
            if (!guestName) {
                alert('Ocorreu um erro. Por favor, tente novamente.');
                return;
            }
            try {
                const currentGift = localGiftsData.find(g => g.id === giftId);
                if (!currentGift || currentGift.chosenCount >= currentGift.quantity) {
                    alert("Ops! Parece que este item nÃ£o estÃ¡ mais disponÃ­vel. A lista foi atualizada.");
                    hideConfirmationModal();
                    return;
                }
                const giftRef = doc(db, "gifts", giftId);
                const updatedChosenBy = [...currentGift.chosenBy, guestName];
                const newChosenCount = currentGift.chosenCount + 1;
                await updateDoc(giftRef, { chosenCount: newChosenCount, chosenBy: updatedChosenBy });
                hideConfirmationModal();
            } catch (error) {
                console.error("Erro ao escolher o presente: ", error);
                alert("Ocorreu um erro ao salvar sua escolha. Tente novamente.");
            }
        };

        const listenForGifts = () => {
            if(isListeningForGifts) return;
            isListeningForGifts = true;
            onSnapshot(collection(db, "gifts"), (snapshot) => {
                const gifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGifts(gifts);
            }, (error) => {
                console.error("Erro ao buscar presentes: ", error);
                giftListContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">NÃ£o foi possÃ­vel carregar a lista.</p>`;
            });
        }
        
        const login = () => {
            const name = guestNameInput.value.trim();
            if (name) {
                guestName = name;
                sessionStorage.setItem('guestName', guestName);
                listenForGifts();
                instructionsModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                nameError.classList.remove('hidden');
            }
        }
        
        const router = () => {
            const hash = window.location.hash;
            guestLoginSection.classList.add('hidden');
            giftSection.classList.add('hidden');
            thankYouSection.classList.add('hidden');
            finishButton.classList.add('hidden');

            if (hash === '#gifts' && guestName) {
                giftSection.classList.remove('hidden');
                finishButton.classList.remove('hidden');
                welcomeGuestName.textContent = guestName;
            } else if (hash === '#thanks' && guestName) {
                thankYouSection.classList.remove('hidden');
            } else {
                guestLoginSection.classList.remove('hidden');
                sessionStorage.removeItem('guestName');
                guestName = '';
            }
        };
        
        window.addEventListener('hashchange', router);
        window.addEventListener('load', () => {
            const savedName = sessionStorage.getItem('guestName');
            if (savedName) {
                guestName = savedName;
                listenForGifts();
            } else if (window.location.hash) {
                window.location.hash = '';
            }
            router();
        });

        closeInstructionsButton.addEventListener('click', () => {
            instructionsModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            window.location.hash = 'gifts';
        });

        startButton.addEventListener('click', login);
        guestNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });
        guestNameInput.addEventListener('input', () => { nameError.classList.add('hidden'); });

        finishButton.addEventListener('click', () => {
            if (!finishButton.disabled) {
                window.location.hash = 'thanks';
            }
        });
    </script>
</body>
</html>
