<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Chá de Casa Nova</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #333;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
        <p class="mt-4 text-gray-600">Carregando...</p>
    </div>

    <!-- Tela Inicial - Nome do Convidado -->
    <div id="welcome-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 z-40">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-purple-600 mb-6">Bem-vindo(a) ao Chá de Casa Nova!</h1>
            <p class="text-center text-gray-600 mb-8">Por favor, digite seu nome e sobrenome para continuar.</p>
            <input type="text" id="guest-name-input" placeholder="Nome Sobrenome" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
            <button id="start-button" class="mt-6 w-full bg-purple-600 text-white font-semibold py-3 rounded-lg hover:bg-purple-700 transition duration-200">Entrar na Lista</button>
        </div>
    </div>

    <!-- Tela Principal - Lista de Presentes -->
    <div id="main-app" class="hidden flex-1 p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-purple-600">Nossa Lista de Presentes</h1>
            <p class="mt-2 text-lg text-gray-600">Olá, <span id="guest-name" class="font-bold"></span>! Escolha seu presente com carinho.</p>
        </header>

        <div id="items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 max-w-6xl mx-auto">
            <!-- Os itens da lista serão renderizados aqui pelo JavaScript -->
        </div>

        <div id="message-container" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-500 text-white p-3 rounded-lg shadow-xl text-center transition-transform duration-300 transform scale-0 opacity-0 z-50">
            <!-- Mensagens de sucesso serão exibidas aqui -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, runTransaction, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Variáveis Globais ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Elementos do DOM ---
        const loadingScreen = document.getElementById('loading-screen');
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainApp = document.getElementById('main-app');
        const startButton = document.getElementById('start-button');
        const guestNameInput = document.getElementById('guest-name-input');
        const guestNameDisplay = document.getElementById('guest-name');
        const itemsList = document.getElementById('items-list');
        const messageContainer = document.getElementById('message-container');

        let db;
        let auth;
        let userId;
        let guestDisplayName = '';

        // --- Dados Iniciais dos Itens ---
        // Se a lista de presentes estiver vazia no banco de dados, usaremos esta lista para populá-la.
        const initialItems = [
            { id: "prato-fundo", name: "Conjunto de Pratos Fundos", link: "https://www.exemplo.com/pratos-fundos", image: "https://placehold.co/400x300/a3e635/000?text=Pratos", initialQuantity: 6 },
            { id: "copos-longos", name: "Conjunto de Copos Longos", link: "https://www.exemplo.com/copos-longos", image: "https://placehold.co/400x300/fde047/000?text=Copos", initialQuantity: 12 },
            { id: "panela-inox", name: "Panela de Aço Inox", link: "https://www.exemplo.com/panela", image: "https://placehold.co/400x300/94a3b8/000?text=Panela", initialQuantity: 2 },
            { id: "jogo-talheres", name: "Jogo de Talheres", link: "https://www.exemplo.com/talheres", image: "https://placehold.co/400x300/f43f5e/000?text=Talheres", initialQuantity: 1 },
            { id: "toalhas-mesa", name: "Toalhas de Mesa", link: "https://www.exemplo.com/toalhas", image: "https://placehold.co/400x300/d8b4fe/000?text=Toalhas", initialQuantity: 4 },
            { id: "aparelho-jantar", name: "Aparelho de Jantar Completo", link: "https://www.exemplo.com/aparelho-jantar", image: "https://placehold.co/400x300/6ee7b7/000?text=Aparelho", initialQuantity: 1 },
            { id: "liquidificador", name: "Liquidificador", link: "https://www.exemplo.com/liquidificador", image: "https://placehold.co/400x300/f9a8d4/000?text=Liquidificador", initialQuantity: 1 },
            { id: "batedeira", name: "Batedeira", link: "https://www.exemplo.com/batedeira", image: "https://placehold.co/400x300/fca5a5/000?text=Batedeira", initialQuantity: 1 }
        ];

        // --- Funções Auxiliares ---

        // Função para mostrar uma mensagem de sucesso na tela
        function showMessage(text, isSuccess = true) {
            messageContainer.textContent = text;
            messageContainer.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl text-center transition-transform duration-300 transform scale-100 opacity-100 z-50 ${isSuccess ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            setTimeout(() => {
                messageContainer.className = messageContainer.className.replace('scale-100 opacity-100', 'scale-0 opacity-0');
            }, 3000);
        }

        // Função para inicializar a lista de itens no Firestore se ela estiver vazia
        async function initializeItems() {
            const itemsCollection = collection(db, `artifacts/${appId}/public/data/items`);
            const firstItemDoc = doc(itemsCollection, initialItems[0].id);
            const docSnap = await getDoc(firstItemDoc);
            if (!docSnap.exists()) {
                console.log("Inicializando lista de presentes no Firestore...");
                for (const item of initialItems) {
                    await setDoc(doc(itemsCollection, item.id), {
                        ...item,
                        claimedCount: 0,
                    });
                }
            }
        }

        // Função para renderizar um item da lista
        function renderItem(item) {
            const available = item.initialQuantity - item.claimedCount;
            const isSoldOut = available <= 0;
            const claimedByThisUser = item.claimedBy && item.claimedBy[userId];

            const itemHTML = `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col items-center p-6 border-4 transition-all duration-300 ${claimedByThisUser ? 'border-purple-500' : 'border-white'}">
                    <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                    <h2 class="text-2xl font-semibold text-center mb-2">${item.name}</h2>
                    <p class="text-lg font-medium text-gray-700 mb-4 text-center">Disponível: ${available} de ${item.initialQuantity}</p>
                    <a href="${item.link}" target="_blank" class="w-full bg-gray-200 text-gray-800 text-center font-medium py-3 rounded-lg hover:bg-gray-300 transition-colors duration-200 mb-3">Ver na Loja</a>
                    <button id="claim-${item.id}" class="w-full font-bold py-3 rounded-lg transition-colors duration-200 ${isSoldOut ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}" ${isSoldOut ? 'disabled' : ''}>
                        ${claimedByThisUser ? 'Você Pegou!' : (isSoldOut ? 'Esgotado' : 'Pegar Item')}
                    </button>
                    ${isSoldOut && item.claimedBy && Object.values(item.claimedBy).length > 0 ? `<p class="mt-2 text-sm text-center text-red-500">Pegue um item diferente!</p>` : ''}
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = itemHTML;
            itemsList.appendChild(div.firstElementChild);

            const claimButton = document.getElementById(`claim-${item.id}`);
            if (claimButton) {
                claimButton.addEventListener('click', () => handleClaimItem(item.id, item.initialQuantity, item.claimedCount));
            }
        }

        // Função para lidar com a ação de "pegar" um item
        async function handleClaimItem(itemId, initialQuantity, claimedCount) {
            if (claimedCount >= initialQuantity) {
                showMessage('Este item já está esgotado!', false);
                return;
            }

            const itemRef = doc(db, `artifacts/${appId}/public/data/items`, itemId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) {
                        throw "Documento não existe!";
                    }

                    const newCount = (itemDoc.data().claimedCount || 0) + 1;
                    const newClaimedBy = itemDoc.data().claimedBy || {};
                    if (newClaimedBy[userId]) {
                        throw "Você já pegou este item!";
                    }
                    newClaimedBy[userId] = guestDisplayName;

                    if (newCount > itemDoc.data().initialQuantity) {
                        throw "Este item foi pego por outro convidado.";
                    }

                    transaction.update(itemRef, { claimedCount: newCount, claimedBy: newClaimedBy });
                });
                showMessage('Item pego com sucesso! Muito obrigado(a)!');
            } catch (e) {
                if (e === "Você já pegou este item!") {
                    showMessage("Você já pegou este item!", false);
                } else if (e === "Este item foi pego por outro convidado.") {
                    showMessage("Que pena! Este item foi pego por outro convidado.", false);
                } else {
                    console.error("Erro ao pegar o item:", e);
                    showMessage('Ocorreu um erro ao pegar o item. Tente novamente.', false);
                }
            }
        }

        // Função principal para iniciar o aplicativo após a autenticação
        async function startApp() {
            loadingScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');

            // Lógica para autenticar o usuário ao clicar no botão
            startButton.addEventListener('click', async () => {
                const name = guestNameInput.value.trim();
                if (name === '') {
                    showMessage('Por favor, digite seu nome.', false);
                    return;
                }

                guestDisplayName = name;
                welcomeScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                guestNameDisplay.textContent = guestDisplayName;
                
                // Inicia o listener de dados do Firestore
                const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/items`);
                onSnapshot(itemsCollectionRef, (querySnapshot) => {
                    itemsList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const itemData = doc.data();
                        renderItem(itemData);
                    });
                });
            });

            // Inicializa a lista de itens no banco de dados se não existir
            await initializeItems();
        }

        // --- Inicialização do Firebase e Autenticação ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            unsubscribe();
                            resolve();
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    }, reject);
                });
                console.log("Firebase autenticado com sucesso. User ID:", userId);
                startApp();
            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                loadingScreen.innerHTML = `<p class="text-red-500 font-semibold text-center">Erro ao conectar com o serviço. Verifique o console para mais detalhes.</p>`;
            }
        }

        // Inicia tudo
        initializeFirebase();
    </script>
</body>
</html>
