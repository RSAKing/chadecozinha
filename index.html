<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes de Chá de Casa Nova</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #f6f8fa, #e9ecef);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-4xl bg-white rounded-3xl shadow-2xl p-6 md:p-10 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-2">Chá de Casa Nova</h1>
        <p class="text-lg md:text-xl text-gray-600 mb-8">
            Bem-vindos! Para nos ajudar a montar a casa nova, por favor, escolha um item da lista abaixo.
        </p>

        <!-- Guest Name Input -->
        <div class="mb-8">
            <label for="guestName" class="block text-gray-700 text-sm font-bold mb-2">Seu nome e sobrenome:</label>
            <input type="text" id="guestName" placeholder="Ex: Maria Silva" class="shadow appearance-none border rounded-xl w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
        </div>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full text-center">
                <p id="messageText" class="text-lg font-semibold text-gray-800 mb-4"></p>
                <button onclick="closeMessageBox()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Fechar
                </button>
            </div>
        </div>

        <!-- Gift List -->
        <div id="giftList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Gift cards will be generated here by JavaScript -->
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // COLOQUE SEU OBJETO DE CONFIGURAÇÃO DO FIREBASE AQUI
        // Você pode encontrar isso nas configurações do seu projeto Firebase na seção "Geral"
        const firebaseConfig = {
            apiKey: "AIzaSyBVaDIEUdAQJnhZzaOQ4pz-HOFPBNHDv1Q",
            authDomain: "chadecozinha-acccc.firebaseapp.com",
            projectId: "chadecozinha-acccc",
            storageBucket: "chadecozinha-acccc.firebasestorage.app",
            messagingSenderId: "459148741363",
            appId: "1:459148741363:web:bb343ec60f71d737184586"
        };
        // FIM DO OBJETO DE CONFIGURAÇÃO

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        getAnalytics(app);

        // O userId não é mais necessário para a exibição, mas ainda pode ser usado internamente
        let userId = null;
        const giftListElement = document.getElementById('giftList');

        // Initial gifts list with placeholder images
        const gifts = [
            { id: 'liquidificador', name: "Liquidificador", image: "https://placehold.co/400x300/e0f2fe/0c4a6e?text=Liquidificador", maxQuantity: 1 },
            { id: 'pratos', name: "Jogo de Pratos", image: "https://placehold.co/400x300/f0f9ff/172554?text=Pratos", maxQuantity: 6 },
            { id: 'cafeteira', name: "Cafeteira", image: "https://placehold.co/400x300/fef2f2/991b1b?text=Cafeteira", maxQuantity: 1 },
            { id: 'micro-ondas', name: "Micro-ondas", image: "https://placehold.co/400x300/f3e8ff/3b0764?text=Micro-ondas", maxQuantity: 1 },
            { id: 'panelas', name: "Conjunto de Panelas", image: "https://placehold.co/400x300/fefce8/713f12?text=Panelas", maxQuantity: 2 },
            { id: 'toalhas', name: "Toalhas de Banho", image: "https://placehold.co/400x300/ecfdf5/042f2e?text=Toalhas", maxQuantity: 4 },
            { id: 'aparelho-jantar', name: "Aparelho de Jantar", image: "https://placehold.co/400x300/f0fdf4/064e3b?text=Jantar", maxQuantity: 1 },
            { id: 'ventilador', name: "Ventilador", image: "https://placehold.co/400x300/fffbeb/78350f?text=Ventilador", maxQuantity: 1 },
            { id: 'copo-termico', name: "Copo Térmico", image: "https://placehold.co/400x300/eef2ff/312e81?text=Copo", maxQuantity: 2 },
        ];

        // Função para exibir mensagens na caixa de diálogo
        function showMessageBox(message) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Função para fechar a caixa de diálogo
        function closeMessageBox() {
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('hidden');
        }

        // Função para inicializar o app e os listeners
        async function initializeAppAndListeners() {
            try {
                // Autenticação anônima para que o usuário possa interagir com o Firestore
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;

                // Configura um listener em tempo real para cada presente
                gifts.forEach(gift => {
                    // Usamos o caminho da coleção 'gifts' no seu próprio projeto Firestore
                    const docRef = doc(db, 'gifts', gift.id);
                    onSnapshot(docRef, (docSnap) => {
                        const data = docSnap.exists() ? docSnap.data() : { quantity: 0, reservedBy: [] };
                        renderGifts({ [gift.id]: data });
                    }, (error) => {
                        console.error("Erro ao escutar dados:", error);
                    });
                });

            } catch (error) {
                console.error("Erro ao inicializar:", error);
                showMessageBox("Ocorreu um erro ao carregar a lista. Por favor, tente novamente.");
            }
        }

        // Objeto para armazenar o estado atual dos presentes do Firestore
        let currentGiftState = {};

        // Função para renderizar a lista de presentes com base nos dados
        function renderGifts(updates = {}) {
            // Atualiza o estado local com os novos dados
            currentGiftState = { ...currentGiftState, ...updates };

            giftListElement.innerHTML = ''; // Limpa a lista antes de renderizar

            gifts.forEach(gift => {
                const reservedQuantity = currentGiftState[gift.id] ? (currentGiftState[gift.id].quantity || 0) : 0;
                const availableQuantity = gift.maxQuantity - reservedQuantity;
                const isAvailable = availableQuantity > 0;

                const giftCard = document.createElement('div');
                giftCard.classList.add('bg-gray-50', 'rounded-2xl', 'shadow-md', 'overflow-hidden', 'hover:shadow-xl', 'transition-shadow', 'duration-300', 'p-4', 'flex', 'flex-col', 'items-center');

                giftCard.innerHTML = `
                    <img src="${gift.image}" alt="${gift.name}" class="w-full h-48 object-cover rounded-xl mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">${gift.name}</h3>
                    <p class="text-gray-500 mb-4 text-sm">Disponíveis: ${availableQuantity}</p>
                    <button class="reserve-btn w-full py-2 px-4 rounded-xl font-bold transition-all duration-300
                        ${isAvailable ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                        data-item-id="${gift.id}"
                        ${!isAvailable ? 'disabled' : ''}>
                        ${isAvailable ? 'Reservar' : 'Esgotado'}
                    </button>
                `;

                giftListElement.appendChild(giftCard);
            });

            document.querySelectorAll('.reserve-btn').forEach(button => {
                button.addEventListener('click', handleReserve);
            });
        }

        // Lida com a ação de reserva
        async function handleReserve(event) {
            if (!userId) {
                showMessageBox("O aplicativo está carregando. Por favor, tente novamente em instantes.");
                return;
            }

            const guestNameInput = document.getElementById('guestName');
            const guestName = guestNameInput.value.trim();
            const itemId = event.target.getAttribute('data-item-id');

            if (!guestName) {
                showMessageBox("Por favor, digite seu nome e sobrenome antes de reservar.");
                return;
            }

            const gift = gifts.find(g => g.id === itemId);
            if (!gift) {
                console.error("Item não encontrado.");
                return;
            }

            // Referência do documento usando o caminho da sua coleção
            const docRef = doc(db, 'gifts', itemId);
            try {
                // Obtém o estado atual do documento
                const docSnap = await getDoc(docRef);
                let currentQuantity = 0;
                let reservedBy = [];

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentQuantity = data.quantity || 0;
                    reservedBy = data.reservedBy || [];
                }

                if (currentQuantity >= gift.maxQuantity) {
                    showMessageBox("Ops! Este item já foi reservado na quantidade máxima.");
                    return;
                }

                // Atualiza o documento com a nova reserva
                await setDoc(docRef, {
                    quantity: currentQuantity + 1,
                    reservedBy: [...reservedBy, { name: guestName, userId: userId }],
                }, { merge: true });

                showMessageBox(`Parabéns, ${guestName}! Você reservou um(a) ${gift.name}. Agradecemos de coração!`);

            } catch (error) {
                console.error("Erro ao reservar presente:", error);
                showMessageBox("Ocorreu um erro ao tentar reservar o presente. Por favor, tente novamente.");
            }
        }

        // Inicia o processo de autenticação e carregamento dos dados quando a página for carregada.
        document.addEventListener('DOMContentLoaded', initializeAppAndListeners);
    </script>
</body>
</html>
